package lab6.server;


import lab6.common.dto.CommandRequestDto;
import lab6.common.dto.PackageDto;
import lab6.server.commands.Commands;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.Serializable;
import java.util.concurrent.BlockingQueue;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;
import java.util.concurrent.LinkedBlockingDeque;


public class ServerRunner  {

    public static BlockingQueue<CommandRequestDto<? extends Serializable>> queueToProcess = new LinkedBlockingDeque<>();
    public static BlockingQueue<PackageDto> queueToSend = new LinkedBlockingDeque<>();

    private static final Logger logger
            = LoggerFactory.getLogger(ServerRunner.class);


    public static void main(String[] args) {


        Commands.temporaryStart();
        Commands.dataBaseToCollection();


        new Thread(() -> {
            ClientReceiver receiver = new ClientReceiver();
            receiver.run();
            // receive thread

        }).start();
        System.out.println("                                     ....................  ................                                                    \n" + "                                      . .. ...     ...........-*++... .. ...                                                   \n" + "                                      ............ .......*#######*.. .......                                                  \n" + "                                      .....................@@+*@##:...... ...                                                  \n" + "                          .  ..............-%######%...........###:..........                                                  \n" + "             .   ....   .........-+=:.......*##@:*##=.........-###:.........                                                   \n" + "                .. ...   ......######*.......%##+-##*.........:###-.... ...                                                    \n" + "              .......... ......##=.@##-......:########+.......+###.... ....                                                    \n" + "            ....-##@...........%#%--###.......###+.-%##-......=@+.........                                                     \n" + "             ....=##-..........=#######%......:######%............... .... .                                                   \n" + "            .....*##%..........*##*..%##*......@@=:........ .............. ..                                                  \n" + "             ....-@##-..........##+..-@@*. .  .....             ....  ........ -*=%@%%+-.. ..... .....                         \n" + "            ......=##@@##@-.....##=....... ..                   ..  .....:*##@+-.......:=@#@:-........                         \n" + "            ......-######@-............ .....                  .......@#%:............. .....:%#+....                          \n" + "             ..   .**-................                   ..........=#%. .. ..... .... ...      ..=@*. ......                   \n" + "            ... ......................                   .......:@#-..  . ..%%......+%...      ....:#=.....                    \n" + "            ... ... ......                               .....-@%...--:::+#@- .......#:..      ......+@-....                   \n" + "             .     ......                                 ...%#-:@##=+:%##=... .......=@-.... ...... .:#-...                   \n" + "                                                         ..-%-*#########=.-%@:  .... ...+%#%+**::-......#*..                   \n" + "                                                         .+@=#####...#####:.-#%.. ..  .-@#+----*##@@#=...#:.                   \n" + "                                                   ..  ..@%+############%#@...#*... -+########=:..*#*....:=.                   \n" + "                                                   .. ..%=-@%#########%..@#*..#+..-%#####:%######%..@#-. .=-                   \n" + "                                                   ....*@-#*%###%:*+-...:##-..#*.*@*####:.-@###@=##-.=%. .+%                   \n" + "                                                   ....#*.#*.###=....-###-...%@.=#.=##########:. :#@.-@:..-#                   \n" + "                                                  ....-@..*%--*%###%==-.....%@..@-.=####=%%+.....:#=..=#. .#....               \n" + "                                                   ...=@..-%*:::-....-::*.:#*...@-.:###=........@#=...+# ..#:..                \n" + "                                                   ...%@....+=--:::::--:+#+.....@=..:#####%%%###=-....:#.. #+.. ..             \n" + "                                                  ....%@..-*..+########*.........#*...*######+........+#.  #+....              \n" + "                                                  ....-@-.......-#*...............%*::-..........-::-%#* ..#-.....             \n" + "                                                   ....#+..........................*#*-::::::::::-:@#-..  :#  .. ..            \n" + "                                                   ....:#-............ ...............+@@@@@#####+*.......=+                   \n" + "                                                    ....*#. .. ...  .. .. ..  ...  ...-..........#=......:#-                   \n" + "                                                   ... ...%=........ .*===-...--..... ..................-#*.                   \n" + "                                                          .*#:..  . ...+#.:%*-.-*%###*-................+#:..                   \n" + "                                                          ...*#*.........:=@=+.......:@#@=*..........-@%....                   \n" + "                                                          .. . -%@...  ....... ..-:-...............-#@.....                    \n" + "                                                         .. . ....-+%%-.......... ..............+%#+.. . ..                    \n" + "                                                                . .. ..+##+--.. .........--*###+..:#-                          \n" + "                                                               .........+%*%#*+=#####%%=**:. . ....=#-                         \n" + "                                                                ..... *+. . .@#=....@#.-----:::::::-#@                         \n" + "                                                                      @*......#+.....%@**:--..-----.-#*    .                   \n" + "                                                                      .%@++*+@#:....-@=... .  ..  ...@=..  .                   \n" + "                                                                      .*#.:%- -=#@+*:*#@*..  ...... .:#:. ..                   \n" + "                                                                      ..%#:%-      .....*@##=:-......-#: ...                   \n" + "                                                                      ...##%.     ....... ..-:+##@+...=@....                   \n" + "                                                                      ....%%.      ...............*@%.+#. .                    \n" + "                                                                       ...+@.                         -#*..                    \n" + "                                                                      ... =%.                         .@@  .                   \n" + "                                                                      . . %=.                         .@# .                    \n" + "                                                                      ..  #+                           @# .                    \n" + "                                                                      ....#++++===%%%%%%%%%%%%%%%%%%%%=##..                    \n" + "                                                                      . ..==%%%==++++++++++++++****:*+++=...                   \n" + "                                                                      . .  .       ............      ... .                     \n" + "                                                                                                                               \n" + "                                                                                                                               \n" + "                                                                                                                               \n" + "                                                                                                                               \n");
        new Thread(() -> {

            // process queue
            ExecutorService executorService = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors() / 2);
            while (true) {
                try {
                    CommandRequestDto<? extends Serializable> commandRequestDto = ServerRunner.queueToProcess.take();
                    //logger.info("Receive command " + commandRequestDto.getCommandName());
                    executorService.execute(() -> Commands.runCommandFromString(Commands.getWorkersSet(), commandRequestDto.getCommandName(), commandRequestDto));

                } catch (InterruptedException e) {
                    executorService.shutdown();
                    break;
                }
            }
        }).start();


        new Thread(() -> {
            // send queue

            ExecutorService executorService = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors() / 2);
            while (true) {
                try {
                    PackageDto packageDto = ServerRunner.queueToSend.take();
                    ClientCaller clientCaller = new ClientCaller();
                    executorService.execute(() -> clientCaller.send(packageDto));
                } catch (InterruptedException e) {
                    executorService.shutdown();
                    break;
                }

            }

        }).start();


        Runtime.getRuntime().addShutdownHook(new Thread() {
            public void run() {
                try {
                    Thread.sleep(200);
                    logger.info("Shutting down ...");
                    System.out.println("                       ..... ............................ .                                                         \n" + "                        ...   ...................*#####=....                                                        \n" + "                          ......................:##%:@##=...                                                        \n" + "                       ..........-@######%-.....+##-..@#*...                                                        \n" + ".... .............................###+:=##=......%#######+..                                                        \n" + "..  ............ ....=####@.......:###-%#=........=##+.+##%.                                                        \n" + "...................:#######+.......@#######@-.....%##+:%##*.                                                        \n" + "......*=+...... ...:###.-###:......*###:.=##*......=####@:..                                                        \n" + ".....%###...... ....###+%####:......@######+................                                                        \n" + "... ..###+... ......#####%@##@-.....:###%-..................                                                        \n" + "... ..+##@..........%##@...=##%-...........                       .....  ....-:**-.... . ......                     \n" + "......-###+.---.....*###:...........                              ....:+##@%*-..--*%@#@*:.... .                     \n" + ".......+#######-....................                              :@#%.. .. .. .. .. ....=#@. .                     \n" + "... ....@#@=*:.............     ....                 ......... :##:.........  . ...      ...:#%- .. .               \n" + "....................... ............                 ........%#+.... ...=#......-:.      ......+#:. .               \n" + ".............. ...........  .... ...                  ... .@#:.......-@#+.... ..:#.      ... . . @%..               \n" + "                                                     ....-#:.+##%%###=....... ...-#=... . ... ....*#-. ....         \n" + "                                                      ..%+:########@+.*@@-... .....-=#=+*-..........#:....          \n" + "                                                     .-#*#####-.-#####-.:#*....  ...:#@@@@@@####+-..:#... .         \n" + "                                               ....  %#+###############..-#:.. ..:#######@-...*#... .%#.. .         \n" + "                                               .....+#.%##########@-.=#...#+...=#####@#######*.-#@....#*...         \n" + "                                               . ..-#-@+@####=%%+....@#...#+.-@.####:..@####@##-.%%...-%...         \n" + "                                               ....#+.@+.###=.....:##=...=#-.#-%##########=..*#%.-#:...#-.          \n" + "                                               ...*#..*=-.=######@*-....*#-.#*.@#######@-....:#%..%#...#:..         \n" + "                                               ...%#...%:::-.....----.-#%...#:.-###%. ......+##-..*#-..#:.          \n" + "                                               ...%#....=*-::::::::-:@#.....#%..:####=*::=###:....-#*..@:..         \n" + "                                               ...%@..-#==###===@##@-........#:...@#######-.  ....:#*..%*..         \n" + "                                               ...+#........-@...............-@.--............-:-*#%...@:..         \n" + "                                                  .#+. .. .......     .........=@::::::::::::--+#=.....#:...        \n" + "                                                .. -#- . ... .  .     ...........-##%+=%%@@###@-......:%...         \n" + "                                                . ..+#........ ..      ..........:%*:::-....*#+.......#-. .         \n" + "                                                     -#*...      ..-+:........................-.....-@:....         \n" + "                                                     ..*#-..     -==+*@@@@@@@##@*--................-#*.....         \n" + "                                                     ....%=.      . .*#%..........-###=...........=#-......         \n" + "                                                     ......*#*....... ...:***+==**... ... ......=#*..               \n" + "                                                     . .......+@=:... .. ... ...... .. .....-*@@.....               \n" + "                                                       . ...   .. :##*...    . . . .. ..-###:.:#...                 \n" + "                                                                  ...@@##%###@@@@@###=::... ...=#...                \n" + "                                                                 .:=-...-#=%*:.-@=... ..--------#%...               \n" + "                                                                 .@-......#+..  .%#@@%*-----:::.*#:.                \n" + "                                                                 .-@%....+#-.....%#. ....     .. #+                 \n" + "                                                                  .-#*=#..-@###@+=@+.....      ..*#..               \n" + "                                                                  ..#%=#.. ... ....-%##=*-...  ..:#*.               \n" + "                                                                 ....### . ..      ... ..@###*....%#.               \n" + "                                                                 ... -@# . ..      ...   ....:+#@.+#-               \n" + "                                                                 .....@# . ..      ..    .. .......#=.  .           \n" + "                                                                 .....@#.                     .. ..#%. . .          \n" + "                                                                 .....@#  ..                   .   %%. . .          \n" + "                                                                  . ..@@.....                  .. .%@.   .          \n" + "                                                                  ....@=. ..                   .. .%@..  .          \n" + "                                                                  .. :#+...                    .. .%@...            \n" + "                                                                 ... *#-. .         .....      . ..%@......         \n" + "                                                                 ....*#::::::::::::::--..........--%%....           \n" + "                                                                 .  .*##############################=.. .           \n" + "                                                                    .      .                      .     .           \n" + "                                                                                                                    \n" + "                                                                                                                    \n");
                } catch (InterruptedException e) {
                    Thread.currentThread().interrupt();
                    e.printStackTrace();
                }
            }
        });
    }
}


